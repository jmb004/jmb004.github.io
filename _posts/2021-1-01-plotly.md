---
layout: post
title: 'Exploring religious data to learn mapping with plotly.express'
published: true
---

## Backstory ##
My interest was to do some basic visual data analysis of a religion in the state of Michigan to understand the religion I belong to and how it is distributed throughout the state. The assumptions are that the data is publicaly available and I will use it to make a map in Python. I also will use Excel to manipulate and clean the data.

## Making the map ##
The data set, Longitudinal Religious Congregations and Membership File, 1980-2010, came from the [Association of Religious Data Archives](https://www.thearda.com/Archive/Files/Downloads/RCMSMGCY_DL2.asp). A guide I used for making the map was [plotly.com](https://plotly.com/python/choropleth-maps/). The idea was to map the various Orthodox adherents to a chloropath style map using the plotly package. Additional guidance on the library was found on [Towards Data Science](https://towardsdatascience.com/choropleth-maps-101-using-plotly-5daf85e7275d).

I pre-processed the data in Excel. This was to filter down to Michigan data. What we are looking at is 3-dimensional long data that I want to analyze. I mean 3-dimensional because the variables I am interested in are # of Adherents, Group County, and Year. I want to focus on the most recent data to get a some-what recent snap-shot of the distribution of adherents.

![Raw data](/images/preprocess.PNG)

## The Discovery ##
H does the mapping function plotly work to read in the data accounting for 3 variables of interest? I could not find a direct answer to this question, so I decided to play around with options to learn how it operates.

The first problem arises in using the plotly library to showcase a 3-variable data-set because multiple records have the same location (County). I attempted to resolve this by creating multiple version of the map. In my first map it was clear that the various data points for one County were not represented but only the first record for that County. For example, if Alleghan County has 3 sub-groups of the Orthodox religion, since there are multiple types of Orthodox Christian groups, then only the first sub-group from the .csv would be mapped.

## Possible Solutions ##
There a few options to arrive at a map that shows 3 variables. First, simply throw out the desire to show 3-variables and reduce the variables in the data set to only 2 (i.e., reduce the variables Year and Group to 1 each) so that the map is a plot of 2 variables. Second, I could use another parameter of the ploty.express function to create a view into a 3rd dimension. This would only look different, but could be harder to interpret quickly. The question is, what do I want to show and what am I willing to sacrifice to show it?

## First Approach ##
I decided to simplify the dataset to 1 year, 2010, and change the scope of the interesting variable (Orthodox denominations) into 1 variable of interest. This allows for a strict 2-variable scale to show the # of Adherents by County. You get a snap-shot of one year as opposed to scalar (time-based) dataset.

![Final processed](/images/csv.PNG)

Now, the data maps quite easily and nicely with plotly.express.

![pre-processed](/images/EO_2010.png)


## Second Approach ##
Using the same dataset, I used the second option found in the [function](https://plotly.com/python-api-reference/generated/plotly.express.choropleth) to create a "subplot" to show that the sub-groups of Orthodox. Using the #facet_row method, it creates multiple maps for each variable selected. It looks messy even with only a little over a dozen values in the Group variable.

![framed_col](/images/facet_row.png)

Then I found another method in the function which is the animation_frame method to showcase the sub-groups while still only in 1 year. While "unorthodox" (pun intended) in method, since this parameter is usually for a time variable, it is a way to see the geographical division by group. 

![animation_frame](/images/animation.png)

## Conclusion ##
This discovery is that a chloropleth map made with the plotly.express function is limited to showcasing a numberical variable on the chloreapath, a geographical variable on the map, and a time-series variable on the animation_frame is great because it gives a lense to view "3-dimensional" datasets. While I was not totally satisfied with the limit of not showcasing all the sub-groups of my control variable (Orthodox demoninations), I was happy to dig into the plot.express function and learn it's features. Considering my main problem, that I wanted to show a non-time-series variable in a graphical way, I imagine that other solutions may exist for it. For me, it seems that that pre-processing the data to remove or reduce a variable is the easiet route to solving my problem. 

The problem still persists: how come the plotly.express function was not able to show multiple records in the same geographical variable? I did find another similar case of this problem with the plotly library in this [article](https://towardsdatascience.com/choropleth-maps-101-using-plotly-5daf85e7275d). In fact, the assumption in the article seems to be that the map function processes the merging of FIPS rows with multiple datapoints in a satisfactorly way. If that's a correct assumption, I have to disagree.

## Further Research ##
It would be interested to distect the code behind the plotly function to understand how it reads and compiles the geographical varialable onto the map. There might be a way to re-work it so that it can show multiple records. It would also be interested to know about other libraries or tools for showing 3-variables in one map. One [Maptitude](https://www.mapping-tools.com/howto/maptitude/appearance/pie-bar-chart/) was shared by Nicholas Thelen.

## Appendix ##
------
    import json,os
    import plotly.express as px
    import pandas as pd
    from urllib.request import urlopen

    # Set directory
    d = os.getcwd()

    # Pull data to be mapped
    df = pd.read_csv(d+r"\ReligiousCongregationsandMembershipStudy2000_MI.csv",dtype={"FIPSMERG":str})
    #df = pd.read_csv(d+r"\EOrtho_MI.csv",dtype={"FIPSMERG":str})

    print(df.columns)
    print("Dropping empty rows...")
    df.isna()
    df.dropna(axis=0, how="any")

    # Create map
    print("Getting map...")
    with urlopen('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json') as response:
        counties = json.load(response)

    counties["features"][0]
    #print(counties["features"][0].keys())

    # Create choropleth map with data
    print("Making map...")
    fig = px.choropleth(df,
                        geojson=counties, # pull counties from the geojson
                        locations="FIPSMERG", # where to get geo-data
                        color="ADHERENT", # what data to scale
                        color_continuous_scale="Viridis", # color pattern of scale?
                        range_color=(df['ADHERENT'].min(), df['ADHERENT'].max()), # set the color number range
                        scope="usa", # starting map view scale
                        hover_name = "CNTYNM",
                        hover_data = ["TOTPOP"], # labels on hover
                        title = "Eastern Orthodox Christians in Michigan in 2010",
                        labels = {"FIPSMERG":"FIPS","GRPNAME":"Jurisdiction","ADHERENT":"Adherents","TOTPOP":"Population"},
                        #facet_row = "GRPNAME"
                        animation_frame = "GRPNAME",
                        )

    #Index(['FIPSMERG', 'CNTYNM', 'TOTPOP', 'GRPNAME', 'ADHERENT'], dtype='object'

    # Set map view
    fig.update_geos(fitbounds="locations")
    """
    fig.update_layout(margin={"r":0,"t":0,"l":0,"b":0},
                      title_text = ,
                      title_font_size=30
                      )
    """

    # Display choropleth
    fig.show()
